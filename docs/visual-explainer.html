<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Engram — Unified Multi-Agent Memory System</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  /* ============ THEME (dark-first neon dashboard) ============ */
  :root {
    --font-body: 'Sora', system-ui, sans-serif;
    --font-mono: 'IBM Plex Mono', 'SF Mono', Consolas, monospace;

    --bg: #0c0e14;
    --surface: #13161f;
    --surface2: #1a1e2a;
    --surface-elevated: #1e2233;
    --border: rgba(255, 255, 255, 0.06);
    --border-bright: rgba(255, 255, 255, 0.12);
    --text: #e2e8f0;
    --text-dim: #7a849b;

    --cyan: #22d3ee;
    --cyan-dim: rgba(34, 211, 238, 0.12);
    --peach: #fb923c;
    --peach-dim: rgba(251, 146, 60, 0.12);
    --green: #4ade80;
    --green-dim: rgba(74, 222, 128, 0.10);
    --violet: #a78bfa;
    --violet-dim: rgba(167, 139, 250, 0.12);
    --rose: #fb7185;
    --rose-dim: rgba(251, 113, 133, 0.10);
    --amber: #fbbf24;
    --amber-dim: rgba(251, 191, 36, 0.10);
    --blue: #60a5fa;
    --blue-dim: rgba(96, 165, 250, 0.10);
  }

  @media (prefers-color-scheme: light) {
    :root {
      --bg: #f8fafc;
      --surface: #ffffff;
      --surface2: #f1f5f9;
      --surface-elevated: #ffffff;
      --border: rgba(0, 0, 0, 0.07);
      --border-bright: rgba(0, 0, 0, 0.14);
      --text: #0f172a;
      --text-dim: #64748b;

      --cyan: #0891b2;
      --cyan-dim: rgba(8, 145, 178, 0.08);
      --peach: #ea580c;
      --peach-dim: rgba(234, 88, 12, 0.08);
      --green: #16a34a;
      --green-dim: rgba(22, 163, 74, 0.08);
      --violet: #7c3aed;
      --violet-dim: rgba(124, 58, 237, 0.08);
      --rose: #e11d48;
      --rose-dim: rgba(225, 29, 72, 0.08);
      --amber: #d97706;
      --amber-dim: rgba(217, 119, 6, 0.08);
      --blue: #2563eb;
      --blue-dim: rgba(37, 99, 235, 0.08);
    }
  }

  /* ============ RESET ============ */
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: var(--bg);
    background-image:
      radial-gradient(ellipse at 30% 0%, var(--cyan-dim) 0%, transparent 50%),
      radial-gradient(ellipse at 70% 100%, var(--violet-dim) 0%, transparent 40%);
    color: var(--text);
    font-family: var(--font-body);
    padding: 40px;
    min-height: 100vh;
    overflow-wrap: break-word;
  }

  /* ============ ANIMATION ============ */
  @keyframes fadeUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes fadeScale { from { opacity: 0; transform: scale(0.92); } to { opacity: 1; transform: scale(1); } }
  @property --count { syntax: '<integer>'; initial-value: 0; inherits: false; }
  @keyframes countUp { to { --count: var(--target); } }
  .animate { animation: fadeUp 0.4s ease-out both; animation-delay: calc(var(--i, 0) * 0.06s); }
  .animate-scale { animation: fadeScale 0.35s ease-out both; animation-delay: calc(var(--i, 0) * 0.06s); }
  @media (prefers-reduced-motion: reduce) { *, *::before, *::after { animation-duration: 0.01ms !important; animation-delay: 0ms !important; transition-duration: 0.01ms !important; } }

  /* ============ NAV LAYOUT ============ */
  .wrap { max-width: 1400px; margin: 0 auto; display: grid; grid-template-columns: 170px 1fr; gap: 0 40px; }
  .main { min-width: 0; }

  .toc { position: sticky; top: 24px; align-self: start; padding: 14px 0; grid-row: 1 / -1; max-height: calc(100dvh - 48px); overflow-y: auto; }
  .toc::-webkit-scrollbar { width: 3px; }
  .toc::-webkit-scrollbar-thumb { background: var(--surface-elevated); border-radius: 2px; }
  .toc-title { font-family: var(--font-mono); font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; color: var(--text-dim); padding: 0 0 10px; margin-bottom: 8px; border-bottom: 1px solid var(--border); }
  .toc a { display: block; font-size: 11px; color: var(--text-dim); text-decoration: none; padding: 4px 8px; border-radius: 5px; border-left: 2px solid transparent; transition: all 0.15s; line-height: 1.4; margin-bottom: 1px; }
  .toc a:hover { color: var(--text); background: var(--surface2); }
  .toc a.active { color: var(--text); border-left-color: var(--cyan); }

  @media (max-width: 1000px) {
    .wrap { grid-template-columns: 1fr; padding-top: 0; }
    body { padding-top: 0; }
    .toc { position: sticky; top: 0; z-index: 200; max-height: none; display: flex; gap: 4px; align-items: center; overflow-x: auto; -webkit-overflow-scrolling: touch; background: var(--bg); border-bottom: 1px solid var(--border); padding: 10px 0; margin: 0 -40px; padding-left: 40px; padding-right: 40px; grid-row: auto; }
    .toc::-webkit-scrollbar { display: none; }
    .toc-title { display: none; }
    .toc a { white-space: nowrap; flex-shrink: 0; border-left: none; border-bottom: 2px solid transparent; border-radius: 4px 4px 0 0; padding: 6px 10px; font-size: 10px; }
    .toc a.active { border-left: none; border-bottom-color: var(--cyan); background: var(--surface); }
    .main { padding-top: 20px; }
    .sec-head { scroll-margin-top: 52px; }
  }

  /* ============ TYPOGRAPHY ============ */
  h1 { font-size: 42px; font-weight: 700; letter-spacing: -1.5px; margin-bottom: 6px; text-wrap: balance; }
  h1 span { background: linear-gradient(135deg, var(--cyan), var(--violet)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
  .subtitle { color: var(--text-dim); font-size: 14px; margin-bottom: 8px; font-family: var(--font-mono); }
  .tagline { color: var(--text-dim); font-size: 13px; line-height: 1.7; margin-bottom: 32px; max-width: 700px; }
  .tagline strong { color: var(--text); }

  /* ============ KPI ROW ============ */
  .kpi-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 14px; margin-bottom: 36px; }
  .kpi-card { background: var(--surface-elevated); border: 1px solid var(--border); border-radius: 10px; padding: 18px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
  .kpi-card__value { font-size: 34px; font-weight: 700; letter-spacing: -1px; line-height: 1.1; font-variant-numeric: tabular-nums; }
  .kpi-card__value--animated { counter-reset: val var(--count); animation: countUp 1.2s ease-out forwards; }
  .kpi-card__value--animated::after { content: counter(val); }
  .kpi-card__label { font-family: var(--font-mono); font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-dim); margin-top: 6px; }

  /* ============ SECTION ============ */
  .sec-head { font-family: var(--font-mono); font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 1.5px; margin-top: 44px; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 8px; }
  .sec-head .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }

  .card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 20px 24px; margin-bottom: 16px; }
  .card--hero { background: var(--surface-elevated); border-color: color-mix(in srgb, var(--border) 50%, var(--cyan) 50%); box-shadow: 0 4px 20px rgba(0,0,0,0.12); }
  .card--recessed { background: var(--surface2); box-shadow: inset 0 1px 3px rgba(0,0,0,0.08); }
  .card h3 { font-size: 15px; font-weight: 600; margin-bottom: 10px; }
  .card p, .card li { font-size: 13px; line-height: 1.7; color: var(--text-dim); }
  .card code { font-family: var(--font-mono); font-size: 11px; background: var(--cyan-dim); color: var(--cyan); padding: 1px 5px; border-radius: 3px; }

  /* ============ GRID LAYOUTS ============ */
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
  .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 14px; }
  .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
  @media (max-width: 768px) { .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; } }
  .grid-2 > *, .grid-3 > *, .grid-4 > * { min-width: 0; }

  /* ============ PIPELINE ============ */
  .pipeline { display: flex; gap: 0; align-items: stretch; overflow-x: auto; padding-bottom: 4px; }
  .pipeline-step { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 10px 14px; min-width: 110px; flex-shrink: 0; text-align: center; }
  .pipeline-step .step-num { font-family: var(--font-mono); font-size: 10px; font-weight: 600; margin-bottom: 4px; }
  .pipeline-step .step-name { font-size: 12px; font-weight: 600; margin-bottom: 3px; }
  .pipeline-step .step-detail { font-size: 10px; color: var(--text-dim); line-height: 1.4; }
  .pipeline-arrow { display: flex; align-items: center; padding: 0 2px; color: var(--border-bright); font-size: 16px; flex-shrink: 0; }
  @media (max-width: 768px) { .pipeline { flex-wrap: wrap; gap: 6px; } .pipeline-arrow { display: none; } }

  /* ============ MERMAID ============ */
  .mermaid-wrap { position: relative; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 32px 24px; overflow: auto; margin-bottom: 16px; scrollbar-width: thin; scrollbar-color: var(--border) transparent; }
  .mermaid-wrap::-webkit-scrollbar { width: 6px; height: 6px; }
  .mermaid-wrap::-webkit-scrollbar-track { background: transparent; }
  .mermaid-wrap::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  .mermaid-wrap .mermaid { display: flex; justify-content: center; transition: transform 0.2s ease; transform-origin: top center; }
  .zoom-controls { position: absolute; top: 8px; right: 8px; display: flex; gap: 2px; z-index: 10; background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 2px; }
  .zoom-controls button { width: 28px; height: 28px; border: none; background: transparent; color: var(--text-dim); font-family: var(--font-mono); font-size: 14px; cursor: pointer; border-radius: 4px; display: flex; align-items: center; justify-content: center; transition: background 0.15s ease, color 0.15s ease; }
  .zoom-controls button:hover { background: var(--border); color: var(--text); }
  .mermaid-wrap.is-zoomed { cursor: grab; }
  .mermaid-wrap.is-panning { cursor: grabbing; user-select: none; }
  .mermaid .nodeLabel { font-family: var(--font-body) !important; font-size: 14px !important; color: var(--text) !important; }
  .mermaid .edgeLabel { font-family: var(--font-mono) !important; font-size: 11px !important; color: var(--text-dim) !important; background-color: var(--bg) !important; }
  .mermaid .edgeLabel rect { fill: var(--bg) !important; }
  .mermaid .node rect, .mermaid .node circle, .mermaid .node polygon { stroke-width: 1.5px !important; }

  /* ============ DATA TABLE ============ */
  .table-wrap { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; margin-bottom: 16px; }
  .table-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .data-table { width: 100%; border-collapse: collapse; font-size: 13px; line-height: 1.5; }
  .data-table thead { position: sticky; top: 0; z-index: 2; }
  .data-table th { background: var(--surface-elevated); font-family: var(--font-mono); font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; color: var(--text-dim); text-align: left; padding: 12px 16px; border-bottom: 2px solid var(--border-bright); white-space: nowrap; }
  .data-table td { padding: 10px 16px; border-bottom: 1px solid var(--border); vertical-align: top; color: var(--text); }
  .data-table tbody tr:nth-child(even) { background: var(--cyan-dim); }
  .data-table tbody tr { transition: background 0.15s ease; }
  .data-table tbody tr:hover { background: var(--border); }
  .data-table tbody tr:last-child td { border-bottom: none; }
  .data-table code { font-family: var(--font-mono); font-size: 11px; background: var(--cyan-dim); color: var(--cyan); padding: 1px 5px; border-radius: 3px; }
  .data-table small { display: block; color: var(--text-dim); font-size: 11px; margin-top: 2px; }

  /* ============ TAGS / LEGEND ============ */
  .tag { font-family: var(--font-mono); font-size: 10px; font-weight: 500; padding: 2px 7px; border-radius: 4px; display: inline-block; }
  .legend { display: flex; gap: 16px; flex-wrap: wrap; margin-bottom: 14px; }
  .legend-item { display: flex; align-items: center; gap: 6px; font-family: var(--font-mono); font-size: 11px; color: var(--text-dim); }
  .legend-swatch { width: 12px; height: 12px; border-radius: 3px; }

  /* ============ NODE LIST ============ */
  .node-list { list-style: none; font-size: 12px; line-height: 1.8; }
  .node-list li { padding-left: 14px; position: relative; }
  .node-list li::before { content: '\203A'; color: var(--text-dim); font-weight: 600; position: absolute; left: 0; }

  /* ============ FLOW ARROW ============ */
  .flow-arrow { display: flex; justify-content: center; align-items: center; gap: 8px; color: var(--text-dim); font-family: var(--font-mono); font-size: 12px; padding: 4px 0; }
  .flow-arrow svg { width: 20px; height: 20px; fill: none; stroke: var(--border-bright); stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

  /* ============ CALLOUT ============ */
  .callout { background: var(--surface2); border: 1px solid var(--border); border-left: 3px solid var(--cyan); border-radius: 0 8px 8px 0; padding: 14px 18px; font-size: 13px; line-height: 1.6; color: var(--text-dim); margin-bottom: 16px; }
  .callout strong { color: var(--text); font-weight: 600; }
  .callout code { font-family: var(--font-mono); font-size: 11px; background: var(--cyan-dim); color: var(--cyan); padding: 1px 5px; border-radius: 3px; }

  /* ============ SCOPE CARD ============ */
  .scope-card { border-radius: 8px; padding: 14px; border: 1px solid var(--border); }
  .scope-card .scope-name { font-weight: 600; font-size: 13px; margin-bottom: 4px; }
  .scope-card .scope-desc { font-size: 11px; color: var(--text-dim); }

  /* ============ LIFECYCLE BADGES ============ */
  .lifecycle-row { display: flex; gap: 4px; flex-wrap: wrap; align-items: center; margin-bottom: 12px; }
  .lifecycle-badge { font-family: var(--font-mono); font-size: 11px; font-weight: 500; padding: 4px 10px; border-radius: 6px; }
  .lifecycle-arrow { color: var(--text-dim); font-size: 14px; }
</style>
</head>
<body>

<div class="wrap">

  <nav class="toc" id="toc">
    <div class="toc-title">Engram</div>
    <a href="#s1">Overview</a>
    <a href="#s2">Architecture</a>
    <a href="#s3">Enrichment Pipeline</a>
    <a href="#s4">Tri-Pathway Recall</a>
    <a href="#s5">Memory Lifecycle</a>
    <a href="#s6">Scopes</a>
    <a href="#s7">Observer Pipeline</a>
    <a href="#s8">Cron Jobs</a>
    <a href="#s9">Claude Code Hooks</a>
    <a href="#s10">Tool Categories</a>
  </nav>

  <div class="main">

    <!-- ═══ HERO ═══ -->
    <h1 class="animate" style="--i:0"><span>Engram</span></h1>
    <p class="subtitle animate" style="--i:1">Unified Multi-Agent Memory System</p>
    <p class="tagline animate" style="--i:2">
      <strong>An elephant never forgets.</strong> Engram is a shared memory layer where AI agents store atomic facts,
      recall context via semantic search, and share knowledge across devices and sessions.
      Cloud-synced through <strong>Convex</strong>. Multimodal embeddings via <strong>Cohere Embed 4</strong>.
    </p>

    <div class="kpi-row">
      <div class="kpi-card animate-scale" style="--i:3">
        <div class="kpi-card__value" style="color: var(--cyan)">72</div>
        <div class="kpi-card__label">MCP Tools</div>
      </div>
      <div class="kpi-card animate-scale" style="--i:4">
        <div class="kpi-card__value" style="color: var(--peach)">17</div>
        <div class="kpi-card__label">Convex Tables</div>
      </div>
      <div class="kpi-card animate-scale" style="--i:5">
        <div class="kpi-card__value" style="color: var(--green)">19</div>
        <div class="kpi-card__label">Cron Jobs</div>
      </div>
      <div class="kpi-card animate-scale" style="--i:6">
        <div class="kpi-card__value" style="color: var(--violet)">1024</div>
        <div class="kpi-card__label">Embedding Dims</div>
      </div>
    </div>

    <!-- ═══ 1. OVERVIEW ═══ -->
    <div id="s1" class="sec-head animate" style="--i:7; color: var(--cyan);">
      <span class="dot" style="background: var(--cyan)"></span> Overview
    </div>

    <div class="grid-3 animate" style="--i:8">
      <div class="card">
        <h3>Store</h3>
        <p>Atomic facts with async enrichment. Embeddings, importance scoring, entity extraction, temporal anchoring, and contradiction detection all happen after the &lt;50ms store response.</p>
      </div>
      <div class="card">
        <h3>Recall</h3>
        <p>Tri-pathway retrieval: semantic vector search + symbolic text search + topological graph expansion, fused via Reciprocal Rank Fusion (RRF, k=60).</p>
      </div>
      <div class="card">
        <h3>Share</h3>
        <p>Scope-based access control: <code>private-{agent}</code>, <code>shared-personal</code>, <code>project-*</code>, <code>team-*</code>, <code>public</code>. O(memberships) lookup via join table.</p>
      </div>
    </div>
    <div class="grid-3 animate" style="--i:9">
      <div class="card">
        <h3>Decay</h3>
        <p>Differential decay by fact type. Decisions decay slowly (0.99/day), observations fast (0.95/day). Emotional memories resist decay via GIZIN emotional weight.</p>
      </div>
      <div class="card">
        <h3>Sync</h3>
        <p>Cloud-synced through Convex. All agents on all devices see the same memory. Vault mirror provides local markdown export with bidirectional reconciliation.</p>
      </div>
      <div class="card">
        <h3>Compress</h3>
        <p>Observer/Reflector pipeline compresses background observations into summaries and digests. Emoji-prefixed tiers: critical, notable, background.</p>
      </div>
    </div>

    <!-- ═══ 2. ARCHITECTURE ═══ -->
    <div id="s2" class="sec-head animate" style="--i:10; color: var(--peach);">
      <span class="dot" style="background: var(--peach)"></span> Three-Tier Architecture
    </div>

    <div class="mermaid-wrap animate" style="--i:11">
      <div class="zoom-controls">
        <button onclick="zoomDiagram(this, 1.2)" title="Zoom in">+</button>
        <button onclick="zoomDiagram(this, 0.8)" title="Zoom out">&minus;</button>
        <button onclick="resetZoom(this)" title="Reset zoom">&#8634;</button>
      </div>
      <pre class="mermaid">
graph TD
  subgraph Agents["Agent Layer"]
    CC["Claude Code"]
    OC["OpenClaw"]
    WS["Windsurf"]
    ANY["Any MCP Client"]
  end

  subgraph MCP["MCP Server Layer (per agent)"]
    TR["Tool Registry<br/>73 tools"]
    EB["Event Bus"]
    SSE["SSE Server"]
    SM["Subscription Mgr"]
    BL["Budget-Aware Loader"]
    RRF["RRF Fusion Engine"]
  end

  subgraph Convex["Convex Cloud Backend"]
    SCHEMA["17 Tables"]
    VS["Vector Search<br/>1024-dim"]
    CRONS["19 Cron Jobs"]
    ACTIONS["Async Actions<br/>embed, enrich, classify"]
  end

  subgraph External["External Services"]
    COHERE["Cohere Embed 4"]
  end

  CC -->|stdio| TR
  OC -->|stdio| TR
  WS -->|stdio| TR
  ANY -->|stdio| TR

  TR --> EB
  EB --> SSE
  EB --> SM

  TR -->|HTTP| SCHEMA
  TR -->|HTTP| VS
  TR --> BL
  BL --> RRF

  ACTIONS --> COHERE
  ACTIONS --> SCHEMA
  CRONS --> SCHEMA
      </pre>
    </div>

    <div class="callout animate" style="--i:12">
      <strong>Agent-Native Principles:</strong> Tools are atomic primitives, not workflow wrappers.
      Agents compose them. Config is prompt-native via <code>memory_set_config</code>.
      Full CRUD on all entity types. <code>memory_list_capabilities</code> for runtime self-discovery.
    </div>

    <!-- ═══ 3. ENRICHMENT PIPELINE ═══ -->
    <div id="s3" class="sec-head animate" style="--i:13; color: var(--green);">
      <span class="dot" style="background: var(--green)"></span> Enrichment Pipeline
    </div>

    <p class="tagline animate" style="--i:14">Facts stored instantly (&lt;50ms). Enrichment runs async in 7 stages.</p>

    <div class="legend animate" style="--i:14">
      <div class="legend-item"><div class="legend-swatch" style="background:var(--cyan)"></div>No LLM</div>
      <div class="legend-item"><div class="legend-swatch" style="background:var(--peach)"></div>Embedding API</div>
      <div class="legend-item"><div class="legend-swatch" style="background:var(--violet)"></div>LLM Call</div>
      <div class="legend-item"><div class="legend-swatch" style="background:var(--green)"></div>DB Write</div>
    </div>

    <div class="card animate" style="--i:15">
      <div class="pipeline">
        <div class="pipeline-step" style="border-color: var(--green-dim);">
          <div class="step-num" style="color: var(--green);">STEP 1</div>
          <div class="step-name">Store Fact</div>
          <div class="step-detail">Immediate write<br/>&lt;50ms response</div>
        </div>
        <div class="pipeline-arrow">&rarr;</div>
        <div class="pipeline-step" style="border-color: var(--peach-dim);">
          <div class="step-num" style="color: var(--peach);">STEP 2</div>
          <div class="step-name">Embed</div>
          <div class="step-detail">Cohere Embed 4<br/>1024 dimensions</div>
        </div>
        <div class="pipeline-arrow">&rarr;</div>
        <div class="pipeline-step" style="border-color: var(--violet-dim);">
          <div class="step-num" style="color: var(--violet);">STEP 3</div>
          <div class="step-name">Classify</div>
          <div class="step-detail">Importance tier<br/>+ observation tier</div>
        </div>
        <div class="pipeline-arrow">&rarr;</div>
        <div class="pipeline-step" style="border-color: var(--cyan-dim);">
          <div class="step-num" style="color: var(--cyan);">STEP 4</div>
          <div class="step-name">Extract</div>
          <div class="step-detail">Entity IDs<br/>+ relationships</div>
        </div>
        <div class="pipeline-arrow">&rarr;</div>
        <div class="pipeline-step" style="border-color: var(--cyan-dim);">
          <div class="step-num" style="color: var(--cyan);">STEP 5</div>
          <div class="step-name">Contradict</div>
          <div class="step-detail">Pre-computed<br/>contradiction check</div>
        </div>
        <div class="pipeline-arrow">&rarr;</div>
        <div class="pipeline-step" style="border-color: var(--cyan-dim);">
          <div class="step-num" style="color: var(--cyan);">STEP 6</div>
          <div class="step-name">Temporal</div>
          <div class="step-detail">Date extraction<br/>7 pattern groups</div>
        </div>
        <div class="pipeline-arrow">&rarr;</div>
        <div class="pipeline-step" style="border-color: var(--green-dim);">
          <div class="step-num" style="color: var(--green);">STEP 7</div>
          <div class="step-name">Notify</div>
          <div class="step-detail">Route to agents<br/>via event bus</div>
        </div>
      </div>
    </div>

    <div class="callout animate" style="--i:16; border-left-color: var(--green);">
      <strong>Temporal Anchoring (new):</strong> Step 6 uses regex-based extraction across 7 date pattern groups
      (named months, ISO, slash formats, tomorrow/yesterday, next [day], next week, in N days/weeks).
      Prefers dates anchored by keywords: <code>deadline</code>, <code>due</code>, <code>by</code>, <code>scheduled</code>.
    </div>

    <!-- ═══ 4. TRI-PATHWAY RECALL ═══ -->
    <div id="s4" class="sec-head animate" style="--i:17; color: var(--violet);">
      <span class="dot" style="background: var(--violet)"></span> Tri-Pathway Recall
    </div>

    <div class="mermaid-wrap animate" style="--i:18">
      <div class="zoom-controls">
        <button onclick="zoomDiagram(this, 1.2)" title="Zoom in">+</button>
        <button onclick="zoomDiagram(this, 0.8)" title="Zoom out">&minus;</button>
        <button onclick="resetZoom(this)" title="Reset zoom">&#8634;</button>
      </div>
      <pre class="mermaid">
graph LR
  Q["Query"] --> SEM["Semantic<br/>Vector Search"]
  Q --> SYM["Symbolic<br/>Text Search"]

  SEM --> RRF["RRF Fusion<br/>k=60"]
  SYM --> RRF

  SEM -.->|"entities found?"| GR["Graph<br/>Expansion"]
  SYM -.->|"entities found?"| GR
  GR -.-> RRF

  RRF --> RANK["Ranked<br/>Results"]
  RANK --> BUMP["Batch<br/>bumpAccess"]
      </pre>
    </div>

    <div class="grid-3 animate" style="--i:19">
      <div class="card" style="border-left: 3px solid var(--cyan);">
        <h3>Semantic Pathway</h3>
        <p>Cohere Embed 4 vector search across permitted scopes. Cosine similarity on 1024-dim embeddings. Primary retrieval path.</p>
      </div>
      <div class="card" style="border-left: 3px solid var(--peach);">
        <h3>Symbolic Pathway</h3>
        <p>Convex full-text search index on <code>content</code> field. Catches exact matches, entity names, and keywords that embeddings miss.</p>
      </div>
      <div class="card" style="border-left: 3px solid var(--green);">
        <h3>Graph Pathway</h3>
        <p>Conditional: only fires when initial results contain <code>entityIds</code>. Expands to find co-occurring facts via entity graph. Capped at 10 results.</p>
      </div>
    </div>

    <div class="callout animate" style="--i:20; border-left-color: var(--violet);">
      <strong>Reciprocal Rank Fusion (RRF):</strong> Each pathway produces a ranked list.
      RRF score = &Sigma; 1/(k + rank) across all pathways where a fact appears.
      Facts in multiple pathways rank higher. k=60 dampens rank position sensitivity.
    </div>

    <!-- ═══ 5. MEMORY LIFECYCLE ═══ -->
    <div id="s5" class="sec-head animate" style="--i:21; color: var(--amber);">
      <span class="dot" style="background: var(--amber)"></span> Memory Lifecycle
    </div>

    <div class="lifecycle-row animate" style="--i:22">
      <span class="lifecycle-badge" style="background: var(--green-dim); color: var(--green);">Active</span>
      <span class="lifecycle-arrow">&rarr;</span>
      <span class="lifecycle-badge" style="background: var(--amber-dim); color: var(--amber);">Dormant</span>
      <span class="lifecycle-arrow">&rarr;</span>
      <span class="lifecycle-badge" style="background: var(--violet-dim); color: var(--violet);">Merged</span>
      <span class="lifecycle-arrow">&rarr;</span>
      <span class="lifecycle-badge" style="background: var(--blue-dim); color: var(--blue);">Archived</span>
      <span class="lifecycle-arrow">&rarr;</span>
      <span class="lifecycle-badge" style="background: var(--rose-dim); color: var(--rose);">Pruned</span>
    </div>

    <div class="grid-2 animate" style="--i:23">
      <div class="card">
        <h3>State Transitions</h3>
        <ul class="node-list">
          <li><strong>Active &rarr; Dormant</strong> &mdash; relevance decays below threshold (differential by fact type)</li>
          <li><strong>Dormant &rarr; Merged</strong> &mdash; weekly consolidation cron merges related facts into themes</li>
          <li><strong>Merged &rarr; Archived</strong> &mdash; forget cron archives facts with high forget score</li>
          <li><strong>Archived &rarr; Pruned</strong> &mdash; garbage collection removes after retention period</li>
          <li><strong>Any &rarr; Active</strong> &mdash; access bump reactivates dormant facts on recall</li>
        </ul>
      </div>
      <div class="card">
        <h3>Decay Resistance</h3>
        <ul class="node-list">
          <li><code>decision</code> facts: slow decay (0.99/day)</li>
          <li><code>observation</code> facts: fast decay (0.95/day)</li>
          <li><code>steering_rule</code> facts: near-permanent (0.999/day)</li>
          <li>Emotional weight (GIZIN) multiplies decay resistance</li>
          <li><code>forgetScore</code> computed by ALMA algorithm: 0.0=keep, 1.0=forget</li>
          <li><code>outcomeScore</code> from MemRL: learned utility from feedback signals</li>
        </ul>
      </div>
    </div>

    <!-- ═══ 6. SCOPES ═══ -->
    <div id="s6" class="sec-head animate" style="--i:24; color: var(--blue);">
      <span class="dot" style="background: var(--blue)"></span> Scope-Based Access Control
    </div>

    <div class="grid-4 animate" style="--i:25">
      <div class="scope-card" style="background: var(--cyan-dim); border-color: var(--cyan);">
        <div class="scope-name" style="color: var(--cyan);">private-{agent}</div>
        <div class="scope-desc">Agent's personal memory. Read/write: creator only. Auto-created on registration.</div>
      </div>
      <div class="scope-card" style="background: var(--green-dim); border-color: var(--green);">
        <div class="scope-name" style="color: var(--green);">shared-personal</div>
        <div class="scope-desc">Inner circle agents. Read: members. Write: members. Session handoffs land here.</div>
      </div>
      <div class="scope-card" style="background: var(--violet-dim); border-color: var(--violet);">
        <div class="scope-name" style="color: var(--violet);">project-*</div>
        <div class="scope-desc">Project-scoped memory. ISC (Ideal State Criteria) tracking. Team collaboration.</div>
      </div>
      <div class="scope-card" style="background: var(--peach-dim); border-color: var(--peach);">
        <div class="scope-name" style="color: var(--peach);">public</div>
        <div class="scope-desc">Read: all agents. Write: members. Cross-agent knowledge sharing.</div>
      </div>
    </div>

    <div class="callout animate" style="--i:26; border-left-color: var(--blue);">
      <strong>O(memberships) lookup:</strong> The <code>scope_memberships</code> join table enables fast scope resolution.
      Instead of scanning all scopes, query by <code>agentId</code> index to find permitted scopes in constant time relative to memberships.
    </div>

    <!-- ═══ 7. OBSERVER/REFLECTOR ═══ -->
    <div id="s7" class="sec-head animate" style="--i:27; color: var(--rose);">
      <span class="dot" style="background: var(--rose)"></span> Observer/Reflector Compression
    </div>

    <p class="tagline animate" style="--i:28">Two-stage compression pipeline for background observations. Reduces prompt token usage.</p>

    <div class="card animate" style="--i:29">
      <div class="pipeline">
        <div class="pipeline-step" style="border-color: var(--green-dim);">
          <div class="step-num" style="color: var(--green);">INPUT</div>
          <div class="step-name">Observations</div>
          <div class="step-detail">Background tier<br/>fire-and-forget</div>
        </div>
        <div class="pipeline-arrow">&rarr;</div>
        <div class="pipeline-step" style="border-color: var(--cyan-dim);">
          <div class="step-num" style="color: var(--cyan);">10K TOKENS</div>
          <div class="step-name">Observer</div>
          <div class="step-detail">Compress to<br/>summaries</div>
        </div>
        <div class="pipeline-arrow">&rarr;</div>
        <div class="pipeline-step" style="border-color: var(--violet-dim);">
          <div class="step-num" style="color: var(--violet);">20K TOKENS</div>
          <div class="step-name">Reflector</div>
          <div class="step-detail">Compress to<br/>digests</div>
        </div>
        <div class="pipeline-arrow">&rarr;</div>
        <div class="pipeline-step" style="border-color: var(--peach-dim);">
          <div class="step-num" style="color: var(--peach);">OUTPUT</div>
          <div class="step-name">System Prompt</div>
          <div class="step-detail">Emoji-prefixed<br/>observation blocks</div>
        </div>
      </div>
    </div>

    <div class="grid-3 animate" style="--i:30">
      <div class="card" style="border-top: 3px solid var(--rose);">
        <h3>Observation Tiers</h3>
        <ul class="node-list">
          <li><span style="color: var(--rose);">&#x1F534;</span> <strong>Critical</strong> &mdash; Always shown</li>
          <li><span style="color: var(--amber);">&#x1F7E1;</span> <strong>Notable</strong> &mdash; Included when space allows</li>
          <li><span style="color: var(--green);">&#x1F7E2;</span> <strong>Background</strong> &mdash; Compressed first</li>
          <li><span style="color: var(--text-dim);">&#x26AA;</span> <strong>Unknown</strong> &mdash; Unclassified</li>
        </ul>
      </div>
      <div class="card" style="border-top: 3px solid var(--rose);">
        <h3>Compression Levels</h3>
        <ul class="node-list">
          <li><strong>Level 0:</strong> Raw observations</li>
          <li><strong>Level 1:</strong> Observer summaries</li>
          <li><strong>Level 2:</strong> Reflector digests</li>
          <li><strong>Level 3:</strong> Max compression</li>
        </ul>
      </div>
      <div class="card" style="border-top: 3px solid var(--rose);">
        <h3>Session Tracking</h3>
        <ul class="node-list">
          <li><code>observation_sessions</code> table tracks per-scope, per-agent state</li>
          <li>Token estimates for pending observations</li>
          <li>Generation counters for idempotency</li>
          <li>10min sweep cron checks thresholds</li>
        </ul>
      </div>
    </div>

    <!-- ═══ 8. CRON JOBS ═══ -->
    <div id="s8" class="sec-head animate" style="--i:31; color: var(--amber);">
      <span class="dot" style="background: var(--amber)"></span> Cron Jobs (19)
    </div>

    <div class="table-wrap animate" style="--i:32">
      <div class="table-scroll">
        <table class="data-table">
          <thead>
            <tr><th>Job</th><th>Schedule</th><th>Purpose</th></tr>
          </thead>
          <tbody>
            <tr><td><code>usage-analytics</code></td><td>Daily 0:30 UTC</td><td>Per-agent daily stats rollup</td></tr>
            <tr><td><code>notification-cleanup</code></td><td>Daily 1:30 UTC</td><td>Expire old notifications</td></tr>
            <tr><td><code>cleanup</code></td><td>Daily 2:00 UTC</td><td>Garbage collection + sync log cleanup</td></tr>
            <tr><td><code>dedup</code></td><td>Daily 2:30 UTC</td><td>Cross-agent deduplication in shared scopes</td></tr>
            <tr><td><code>decay</code></td><td>Daily 3:00 UTC</td><td>Differential relevance decay by fact type</td></tr>
            <tr><td><code>forget</code></td><td>Daily 3:30 UTC</td><td>Archive facts with high forget score (ALMA)</td></tr>
            <tr><td><code>compact</code></td><td>Daily 4:00 UTC</td><td>Conversation compaction</td></tr>
            <tr><td><code>quality-scan</code></td><td>Daily 4:30 UTC</td><td>Golden principles quality scan</td></tr>
            <tr><td><code>rules</code></td><td>Daily 7:00 UTC</td><td>Steering rule extraction (monthly exec)</td></tr>
            <tr><td><code>consolidate</code></td><td>Weekly Sun 5:00</td><td>Merge related facts into themes</td></tr>
            <tr><td><code>rerank</code></td><td>Weekly Sun 6:00</td><td>Importance recalculation</td></tr>
            <tr><td><code>learning-synthesis</code></td><td>Weekly Sun 7:30</td><td>Feedback signal synthesis</td></tr>
            <tr><td><code>update-golden-principles</code></td><td>Weekly Mon 8:00</td><td>Promote patterns into golden principles</td></tr>
            <tr><td><code>vault-sync-heartbeat</code></td><td>Every 5 min</td><td>Vault mirror sync heartbeat</td></tr>
            <tr><td><code>vault-regenerate-indices</code></td><td>Every 5 min</td><td>Vault index regeneration trigger</td></tr>
            <tr><td><code>observer-sweep</code></td><td>Every 10 min</td><td>Observer/Reflector threshold sweep</td></tr>
            <tr><td><code>embedding-backfill</code></td><td>Every 15 min</td><td>Re-embed failed facts</td></tr>
            <tr><td><code>action-recommendations</code></td><td>Every 15 min</td><td>Proactive action recommendations</td></tr>
            <tr><td><code>agent-health</code></td><td>Every 30 min</td><td>Stale agent detection + notifications</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ═══ 9. HOOKS ═══ -->
    <div id="s9" class="sec-head animate" style="--i:33; color: var(--green);">
      <span class="dot" style="background: var(--green)"></span> Claude Code Hooks (8)
    </div>

    <div class="table-wrap animate" style="--i:34">
      <div class="table-scroll">
        <table class="data-table">
          <thead>
            <tr><th>Event</th><th>Script</th><th>Purpose</th><th>Perf</th></tr>
          </thead>
          <tbody>
            <tr><td><code>SessionStart</code></td><td>session-start.sh</td><td>Auto-inject agent context (identity, scopes, notifications)</td><td>~50-200ms</td></tr>
            <tr><td><code>UserPromptSubmit</code></td><td>auto-recall.sh</td><td>Auto-recall top-3 relevant memories per prompt</td><td>~100-500ms</td></tr>
            <tr><td><code>PostToolUse</code></td><td>post-tool-observe.sh</td><td>Record file edit observations (async, fire-and-forget)</td><td>~10-50ms</td></tr>
            <tr><td><code>Notification</code></td><td>notification-alert.sh</td><td>Desktop alerts when memory needs attention</td><td>&lt;10ms</td></tr>
            <tr><td><code>PreToolUse</code></td><td>validate-memory-ops.sh</td><td>Warn about destructive memory operations</td><td>&lt;5ms</td></tr>
            <tr><td><code>Stop</code></td><td>auto-handoff.sh</td><td>Record turn completion events (async)</td><td>~50-100ms</td></tr>
            <tr><td><code>PreCompact</code></td><td>pre-compact-checkpoint.sh</td><td>Checkpoint state before context compaction</td><td>~100-500ms</td></tr>
            <tr><td><code>SessionEnd</code></td><td>session-end.sh</td><td>Auto-end session with handoff summary</td><td>~100-500ms</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ═══ 10. TOOL CATEGORIES ═══ -->
    <div id="s10" class="sec-head animate" style="--i:35; color: var(--cyan);">
      <span class="dot" style="background: var(--cyan)"></span> MCP Tool Categories (72)
    </div>

    <div class="grid-3 animate" style="--i:36">
      <div class="card" style="border-left: 3px solid var(--cyan);">
        <h3>Core (6)</h3>
        <ul class="node-list">
          <li><code>store_fact</code> <code>recall</code> <code>search</code></li>
          <li><code>observe</code> <code>link_entity</code> <code>get_context</code></li>
        </ul>
      </div>
      <div class="card" style="border-left: 3px solid var(--peach);">
        <h3>Fact Lifecycle (6)</h3>
        <ul class="node-list">
          <li><code>update_fact</code> <code>archive_fact</code></li>
          <li><code>boost_relevance</code> <code>list_stale_facts</code></li>
          <li><code>mark_facts_merged</code> <code>mark_facts_pruned</code></li>
        </ul>
      </div>
      <div class="card" style="border-left: 3px solid var(--green);">
        <h3>Signals (3)</h3>
        <ul class="node-list">
          <li><code>record_signal</code> ratings + sentiment</li>
          <li><code>record_feedback</code> recall usefulness</li>
          <li><code>record_recall</code> track recall events</li>
        </ul>
      </div>
    </div>
    <div class="grid-3 animate" style="--i:37">
      <div class="card" style="border-left: 3px solid var(--violet);">
        <h3>Agent (5)</h3>
        <ul class="node-list">
          <li><code>register_agent</code> <code>end_session</code></li>
          <li><code>get_agent_info</code> <code>get_agent_context</code></li>
          <li><code>get_system_prompt</code></li>
        </ul>
      </div>
      <div class="card" style="border-left: 3px solid var(--amber);">
        <h3>Retrieval (11)</h3>
        <ul class="node-list">
          <li><code>vector_search</code> <code>text_search</code></li>
          <li><code>rank_candidates</code> <code>bump_access</code></li>
          <li><code>get_observations</code> <code>get_entities</code></li>
          <li><code>get_themes</code> <code>get_handoffs</code></li>
          <li><code>search_facts</code> <code>search_entities</code></li>
          <li><code>search_themes</code></li>
        </ul>
      </div>
      <div class="card" style="border-left: 3px solid var(--blue);">
        <h3>Context (7)</h3>
        <ul class="node-list">
          <li><code>resolve_scopes</code> <code>load_budgeted_facts</code></li>
          <li><code>search_daily_notes</code></li>
          <li><code>get_graph_neighbors</code></li>
          <li><code>get_activity_stats</code></li>
          <li><code>get_workspace_info</code></li>
          <li><code>build_system_prompt</code></li>
        </ul>
      </div>
    </div>
    <div class="grid-3 animate" style="--i:38">
      <div class="card" style="border-left: 3px solid var(--rose);">
        <h3>Events (7)</h3>
        <ul class="node-list">
          <li><code>poll_events</code> <code>get_notifications</code></li>
          <li><code>mark_notifications_read</code></li>
          <li><code>subscribe</code> <code>unsubscribe</code></li>
          <li><code>list_subscriptions</code></li>
          <li><code>poll_subscription</code></li>
        </ul>
      </div>
      <div class="card" style="border-left: 3px solid var(--peach);">
        <h3>Vault (9)</h3>
        <ul class="node-list">
          <li><code>vault_sync</code> <code>vault_export</code></li>
          <li><code>vault_import</code> <code>vault_list_files</code></li>
          <li><code>vault_reconcile</code> <code>query_vault</code></li>
          <li><code>export_graph</code> <code>checkpoint</code> <code>wake</code></li>
        </ul>
      </div>
      <div class="card" style="border-left: 3px solid var(--green);">
        <h3>Admin + Health (13)</h3>
        <ul class="node-list">
          <li>Config: <code>get_config</code> <code>list_configs</code> <code>set_config</code> <code>set_scope_policy</code></li>
          <li>Delete: <code>delete_entity</code> <code>delete_scope</code> <code>delete_conversation</code> <code>delete_session</code> <code>delete_theme</code></li>
          <li>Composition: <code>summarize</code> <code>prune</code> <code>create_theme</code> <code>query_raw</code></li>
          <li>Discovery: <code>list_capabilities</code></li>
          <li>Health: <code>health</code></li>
        </ul>
      </div>
    </div>

    <!-- ═══ FOOTER ═══ -->
    <div class="callout animate" style="--i:39; border-left-color: var(--violet); margin-top: 32px;">
      <strong>Engram</strong> &mdash; Unified multi-agent memory. 73 MCP tools &middot; 18 Convex tables &middot; 19 cron jobs &middot; Cohere Embed 4 (1024-dim).
      <br/>Agent-native architecture: tools as primitives, agents compose them, config via prompts not code.
    </div>

  </div><!-- /main -->
</div><!-- /wrap -->

<!-- ═══ MERMAID ═══ -->
<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';

  const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  mermaid.initialize({
    startOnLoad: true,
    theme: 'base',
    look: 'classic',
    themeVariables: {
      primaryColor: isDark ? '#1e2233' : '#e0f2fe',
      primaryBorderColor: isDark ? '#22d3ee' : '#0891b2',
      primaryTextColor: isDark ? '#e2e8f0' : '#0f172a',
      secondaryColor: isDark ? '#2e2233' : '#fae8ff',
      secondaryBorderColor: isDark ? '#a78bfa' : '#7c3aed',
      secondaryTextColor: isDark ? '#e2e8f0' : '#0f172a',
      tertiaryColor: isDark ? '#2e2618' : '#fffbeb',
      tertiaryBorderColor: isDark ? '#fbbf24' : '#d97706',
      tertiaryTextColor: isDark ? '#e2e8f0' : '#0f172a',
      lineColor: isDark ? '#475569' : '#94a3b8',
      fontSize: '14px',
      fontFamily: "'Sora', system-ui, sans-serif",
    }
  });
</script>

<!-- ═══ ZOOM + PAN ═══ -->
<script>
  function updateZoomState(wrap) {
    var target = wrap.querySelector('.mermaid');
    var zoom = parseFloat(target.dataset.zoom || '1');
    wrap.classList.toggle('is-zoomed', zoom > 1);
  }
  function zoomDiagram(btn, factor) {
    var wrap = btn.closest('.mermaid-wrap');
    var target = wrap.querySelector('.mermaid');
    var current = parseFloat(target.dataset.zoom || '1');
    var next = Math.min(Math.max(current * factor, 0.3), 5);
    target.dataset.zoom = next;
    target.style.transform = 'scale(' + next + ')';
    updateZoomState(wrap);
  }
  function resetZoom(btn) {
    var wrap = btn.closest('.mermaid-wrap');
    var target = wrap.querySelector('.mermaid');
    target.dataset.zoom = '1';
    target.style.transform = 'scale(1)';
    updateZoomState(wrap);
  }
  document.querySelectorAll('.mermaid-wrap').forEach(function(wrap) {
    wrap.addEventListener('wheel', function(e) {
      if (!e.ctrlKey && !e.metaKey) return;
      e.preventDefault();
      var target = wrap.querySelector('.mermaid');
      var current = parseFloat(target.dataset.zoom || '1');
      var factor = e.deltaY < 0 ? 1.1 : 0.9;
      var next = Math.min(Math.max(current * factor, 0.3), 5);
      target.dataset.zoom = next;
      target.style.transform = 'scale(' + next + ')';
      updateZoomState(wrap);
    }, { passive: false });
    var startX, startY, scrollL, scrollT;
    wrap.addEventListener('mousedown', function(e) {
      if (e.target.closest('.zoom-controls')) return;
      var target = wrap.querySelector('.mermaid');
      if (parseFloat(target.dataset.zoom || '1') <= 1) return;
      wrap.classList.add('is-panning');
      startX = e.clientX; startY = e.clientY;
      scrollL = wrap.scrollLeft; scrollT = wrap.scrollTop;
    });
    window.addEventListener('mousemove', function(e) {
      if (!wrap.classList.contains('is-panning')) return;
      wrap.scrollLeft = scrollL - (e.clientX - startX);
      wrap.scrollTop = scrollT - (e.clientY - startY);
    });
    window.addEventListener('mouseup', function() { wrap.classList.remove('is-panning'); });
  });
</script>

<!-- ═══ SCROLL SPY ═══ -->
<script>
(function() {
  var toc = document.getElementById('toc');
  var links = toc.querySelectorAll('a');
  var sections = [];
  links.forEach(function(link) {
    var id = link.getAttribute('href').slice(1);
    var el = document.getElementById(id);
    if (el) sections.push({ id: id, el: el, link: link });
  });
  var observer = new IntersectionObserver(function(entries) {
    entries.forEach(function(entry) {
      if (entry.isIntersecting) {
        links.forEach(function(l) { l.classList.remove('active'); });
        var match = sections.find(function(s) { return s.el === entry.target; });
        if (match) {
          match.link.classList.add('active');
          if (window.innerWidth <= 1000) {
            match.link.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
          }
        }
      }
    });
  }, { rootMargin: '-10% 0px -80% 0px' });
  sections.forEach(function(s) { observer.observe(s.el); });
  links.forEach(function(link) {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      var id = link.getAttribute('href').slice(1);
      var el = document.getElementById(id);
      if (el) { el.scrollIntoView({ behavior: 'smooth', block: 'start' }); history.replaceState(null, '', '#' + id); }
    });
  });
})();
</script>

</body>
</html>
