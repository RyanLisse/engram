name: Weekly Quality Report

on:
  schedule:
    # Sunday at 23:00 UTC (end of week report)
    - cron: '0 23 * * 0'
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  generate-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'mcp-server/package-lock.json'

      - name: Install dependencies
        run: |
          cd mcp-server
          npm ci

      - name: Run validation
        run: |
          mcp-server/node_modules/.bin/tsx scripts/validate-golden-principles.ts --json > current-validation.json

      - name: Generate quality report
        run: |
          cat > docs/QUALITY-REPORT-$(date +%Y-%m-%d).md << 'EOF'
          # Engram Code Quality Report

          **Generated**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Week**: Week $(date +%V), $(date +%Y)

          EOF

          # Extract metrics
          GRADE=$(jq -r '.grade' current-validation.json)
          TOTAL=$(jq -r '.violations | length' current-validation.json)
          CRITICAL=$(jq -r '.summary.critical' current-validation.json)
          HIGH=$(jq -r '.summary.high' current-validation.json)
          MEDIUM=$(jq -r '.summary.medium' current-validation.json)
          FILES=$(jq -r '.summary.totalFiles' current-validation.json)

          cat >> docs/QUALITY-REPORT-$(date +%Y-%m-%d).md << EOF
          ## Summary

          **Overall Grade**: $GRADE
          **Total Files Checked**: $FILES
          **Total Violations**: $TOTAL

          | Severity | Count |
          |----------|-------|
          | ðŸ”´ Critical | $CRITICAL |
          | ðŸŸ  High | $HIGH |
          | ðŸŸ¡ Medium | $MEDIUM |

          ## Trend Analysis

          _Compare with previous week's report to see improvement_

          ## Top Violations

          EOF

          # Add violation details
          jq -r '.violations | group_by(.principle) | map({principle: .[0].principle, count: length}) | sort_by(.count) | reverse | .[] | "### \(.principle) (\(.count) violations)"' current-validation.json >> docs/QUALITY-REPORT-$(date +%Y-%m-%d).md

          cat >> docs/QUALITY-REPORT-$(date +%Y-%m-%d).md << 'EOF'

          ## Action Items

          EOF

          if [ "$CRITICAL" -gt 0 ]; then
            echo "- ðŸ”´ **URGENT**: Fix $CRITICAL critical violation(s)" >> docs/QUALITY-REPORT-$(date +%Y-%m-%d).md
          fi

          if [ "$HIGH" -gt 5 ]; then
            echo "- ðŸŸ  **Important**: Address $HIGH high-priority violations" >> docs/QUALITY-REPORT-$(date +%Y-%m-%d).md
          fi

          cat >> docs/QUALITY-REPORT-$(date +%Y-%m-%d).md << 'EOF'

          ## Resources

          - [Golden Principles](./GOLDEN-PRINCIPLES.md)
          - [Harness Engineering Guide](./HARNESS-ENGINEERING-OPTIMIZATION.md)
          - [Validation Tool](../scripts/validate-golden-principles.ts)

          ---

          ðŸ¤– Generated by [Quality Report workflow](../.github/workflows/quality-report.yml)
          EOF

      - name: Commit report
        run: |
          git config user.name "Harness Quality Bot"
          git config user.email "noreply@github.com"
          git add docs/QUALITY-REPORT-*.md
          git commit -m "docs(harness): weekly quality report $(date +%Y-%m-%d)" || echo "No changes to commit"
          git push || echo "No changes to push"

      - name: Create quality issue if grade dropped
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('current-validation.json', 'utf8'));

            // Check if we should create an issue (grade C or lower, or critical violations)
            if (results.grade === 'C' || results.grade === 'D' || results.grade === 'F' || results.summary.critical > 0) {
              const title = `ðŸ“Š Quality Report: Grade ${results.grade} - Action Required`;
              const body = `## Weekly Quality Report Alert

            **Date**: ${new Date().toISOString().split('T')[0]}
            **Overall Grade**: ${results.grade}
            **Status**: âš ï¸ Below target (Grade B+ or better)

            ### Metrics

            - **Total Violations**: ${results.violations.length}
            - **Critical**: ${results.summary.critical}
            - **High**: ${results.summary.high}
            - **Medium**: ${results.summary.medium}

            ### Recommended Actions

            ${results.summary.critical > 0 ? `
            1. ðŸš¨ **URGENT**: Fix ${results.summary.critical} critical violation(s) immediately
            ` : ''}
            ${results.summary.high > 0 ? `
            2. ðŸ”´ Address ${results.summary.high} high-priority violations this week
            ` : ''}
            3. ðŸ“ˆ Target: Improve to Grade B+ by next report

            ### Full Report

            See [Quality Report](../blob/main/docs/QUALITY-REPORT-${new Date().toISOString().split('T')[0]}.md)

            ### Resources

            - [Golden Principles](../blob/main/docs/GOLDEN-PRINCIPLES.md)
            - [Harness Engineering Guide](../blob/main/docs/HARNESS-ENGINEERING-OPTIMIZATION.md)

            ---

            ðŸ¤– Generated by [Quality Report workflow](../actions/workflows/quality-report.yml)
            `;

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['harness-engineering', 'quality-report', 'needs-attention']
              });
            }
