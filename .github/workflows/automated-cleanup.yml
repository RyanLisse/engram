name: Automated Harness Cleanup

on:
  schedule:
    # Weekly cleanup every Monday at 7am UTC
    - cron: '0 7 * * 1'
  workflow_dispatch:
    inputs:
      principles:
        description: 'Principles to fix (comma-separated, e.g., GP-004,GP-005)'
        required: false
        default: 'all'

permissions:
  contents: write
  pull-requests: write
  issues: read

jobs:
  cleanup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'mcp-server/package-lock.json'

      - name: Install dependencies
        run: |
          cd mcp-server
          npm ci

      - name: Run validation to find violations
        id: validate
        run: |
          mcp-server/node_modules/.bin/tsx scripts/validate-golden-principles.ts --json > violations.json
          cat violations.json

          TOTAL=$(jq -r '.violations | length' violations.json)
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

          if [ "$TOTAL" -eq 0 ]; then
            echo "‚úÖ No violations found. Cleanup not needed."
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Auto-fix GP-004 violations (stdout logging)
        if: steps.validate.outputs.skip == 'false'
        run: |
          # Find and fix console.log in MCP server
          find mcp-server/src -name "*.ts" -type f -exec sed -i.bak 's/console\.log(/console.error(/g' {} +
          find mcp-server/src -name "*.bak" -type f -delete

          # Count changes
          if git diff --quiet; then
            echo "No GP-004 violations to fix"
          else
            echo "Fixed GP-004 violations"
            git add mcp-server/src
          fi

      - name: Auto-fix GP-005 violations (structured logging)
        if: steps.validate.outputs.skip == 'false'
        run: |
          # This is a placeholder for structured logging fixes
          # Would need more sophisticated regex for proper implementation
          echo "GP-005 auto-fix requires manual review"

      - name: Create summary of fixes
        if: steps.validate.outputs.skip == 'false'
        id: summary
        run: |
          # Generate summary of what was fixed
          CHANGED=$(git diff --name-only | wc -l)
          echo "changed=$CHANGED" >> $GITHUB_OUTPUT

          if [ "$CHANGED" -gt 0 ]; then
            cat > fix-summary.md << 'EOF'
          ## Automated Fixes Applied

          This PR was generated automatically by the Harness Engineering cleanup workflow.

          ### Fixes

          EOF

            git diff --name-only | while read file; do
              echo "- Fixed violations in \`$file\`" >> fix-summary.md
            done

            cat >> fix-summary.md << 'EOF'

          ### Validation

          - [x] Golden principles validation will run automatically
          - [x] All automated fixes are mechanical transformations
          - [x] Review time: <2 minutes expected

          ### What was fixed

          - **GP-004**: Replaced `console.log` with `console.error` in MCP server (stdout reserved for JSON-RPC)

          ### Resources

          - [Golden Principles](../blob/main/docs/GOLDEN-PRINCIPLES.md)
          - [Harness Engineering Guide](../blob/main/docs/HARNESS-ENGINEERING-OPTIMIZATION.md)

          ---

          ü§ñ Generated by [Automated Cleanup workflow](../actions/workflows/automated-cleanup.yml)
          EOF
          fi

      - name: Create Pull Request
        if: steps.validate.outputs.skip == 'false' && steps.summary.outputs.changed > 0
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            ü§ñ fix(harness): automated golden principles cleanup

            Auto-fixed violations found during scheduled validation:
            - GP-004: stdout logging in MCP server

            This is a mechanical transformation following golden principles.
            Review time: <2 minutes expected.

            Co-Authored-By: Harness Cleanup Bot <noreply@github.com>
          branch: automated-cleanup/${{ github.run_number }}
          delete-branch: true
          title: 'ü§ñ Automated Harness Engineering Cleanup'
          body-path: fix-summary.md
          labels: |
            harness-engineering
            automated-cleanup
            low-priority
          assignees: ${{ github.repository_owner }}
          reviewers: ${{ github.repository_owner }}

      - name: Post summary
        run: |
          if [ "${{ steps.validate.outputs.skip }}" == "true" ]; then
            echo "‚úÖ No violations found. Cleanup not needed."
          elif [ "${{ steps.summary.outputs.changed }}" == "0" ]; then
            echo "‚ÑπÔ∏è Violations found but no automatic fixes available."
            echo "Manual review required."
          else
            echo "‚úÖ Created cleanup PR with ${{ steps.summary.outputs.changed }} file(s) fixed."
          fi
